{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Login | VolunteerHub</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

<div class="auth-container">

    <!-- LEFT PANEL -->
    <div class="auth-left">
        <h1>Welcome Back!</h1>
        <p>
            Sign in to access your dashboard and continue making
            a difference in your community.
        </p>

        <div class="features">
            ‚úî AI-powered fair volunteer selection<br>
            ‚úî Track participation & growth<br>
            ‚úî Community impact
        </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="auth-right">
        <div class="auth-card">

            <!-- ROLE TABS -->
            <div class="tabs">
                <div class="tab volunteer active" data-role="VOLUNTEER">
                    üë§ Volunteer
                </div>
                <div class="tab organization" data-role="ORGANIZATION">
                    üè¢ Organization
                </div>
                <div class="tab admin" data-role="ADMIN">
                    üõ°Ô∏è Admin
                </div>
            </div>

            <!-- DYNAMIC TITLE -->
            <h2 id="loginTitle">Volunteer Login</h2>

            <!-- CSRF -->
            <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

            <!-- LOGIN FORM -->
            <form id="loginForm">

                <input id="username" type="email" placeholder="Email address" required>

                <div class="password-box">
                    <input id="password" type="password" placeholder="Password" required>
                    <span onclick="togglePassword()">üëÅÔ∏è</span>
                </div>

                <button type="submit">Sign In</button>
                <div id="loginError" class="error-message"></div>
            </form>

            <div class="switch-text">
                Don't have an account?
                <a href="/register/">Register here</a>
            </div>

        </div>
    </div>

</div>

<script>
let selectedRole = "VOLUNTEER";

/* -------- ROLE TAB CLICK -------- */
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        setRole(tab.dataset.role);
    });
});

/* -------- SET ROLE FUNCTION -------- */
function setRole(role) {
    selectedRole = role;

    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[data-role="${role}"]`).classList.add("active");

    const titles = {
        "VOLUNTEER": "Volunteer Login",
        "ORGANIZATION": "Organization Login",
        "ADMIN": "Admin Login"
    };

    document.getElementById("loginTitle").innerText = titles[role];
}

/* -------- AUTO ROLE DETECTION FROM EMAIL -------- */
document.getElementById("username").addEventListener("input", function () {
    const email = this.value;

    if (email.endsWith("@srit.ac.in")) {
        setRole("VOLUNTEER");
    } 
    else if (email.endsWith("@gmail.com")) {
        setRole("ORGANIZATION");
    }
});

/* -------- LOGIN SUBMIT -------- */
document.getElementById("loginForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const errorBox = document.getElementById("loginError");
    errorBox.style.display = "none";

    try {
        const res = await fetch("/api/login/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.getElementById("csrfToken").value
            },
            body: JSON.stringify({
                username: document.getElementById("username").value,
                password: document.getElementById("password").value,
                role: selectedRole
            })
        });

        const data = await res.json();

        if (data.status === "success") {
            if (data.role === "VOLUNTEER")
                window.location.href = "/volunteer/dashboard/";
            else if (data.role === "ORGANIZATION")
                window.location.href = "/organization/dashboard/";
            else
                window.location.href = "/admin_panel/dashboard/";
        } else {
            errorBox.innerText = data.message || "Login failed";
            errorBox.style.display = "block";
        }

    } catch (err) {
        errorBox.innerText = "Server error. Try again.";
        errorBox.style.display = "block";
    }
});

/* -------- PASSWORD TOGGLE -------- */
function togglePassword() {
    const pwd = document.getElementById("password");
    pwd.type = pwd.type === "password" ? "text" : "password";
}
</script>

</body>
</html>
