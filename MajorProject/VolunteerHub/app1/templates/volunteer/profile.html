{% extends "base_volunteer.html" %}
{% load static %}
{% block content %}

<style>
.profile-wrapper{
    max-width:1100px;
    margin:auto;
}
/* BUTTON GROUP */
.btn-group{
    display:flex;
    gap:12px;
}

/* SMOOTH EDIT EFFECT */
.editable{
    transition: all 0.3s ease;
}

.editable.enabled{
    border:2px solid #4f46e5;
    background:#eef2ff;
}

/* CANCEL BUTTON */
#cancelBtn{
    background:#ef4444;
}

/* TOAST MESSAGE */
.toast{
    position:fixed;
    top:20px;
    right:20px;
    background:#10b981;
    color:white;
    padding:14px 20px;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    opacity:0;
    transform:translateY(-20px);
    transition:all 0.4s ease;
}

.toast.show{
    opacity:1;
    transform:translateY(0);
}


/* COVER */
.cover{
    height:260px;
    border-radius:20px;
    position:relative;
    background-size:cover;
    background-position:center;
}

.cover label{
    position:absolute;
    right:20px;
    bottom:20px;
    background:rgba(0,0,0,.6);
    color:white;
    padding:8px 14px;
    border-radius:20px;
    cursor:pointer;
}

/* PROFILE PIC */
.avatar{
    position:relative;
    width:160px;
    height:160px;
    margin:-80px 0 0 40px;
}

.avatar img{
    width:160px;
    height:160px;
    border-radius:50%;
    border:6px solid white;
    object-fit:cover;
}

.avatar label{
    position:absolute;
    bottom:10px;
    right:10px;
    background:#4f46e5;
    color:white;
    padding:6px 10px;
    border-radius:50%;
    cursor:pointer;
}

/* INFO GRID */
.info-grid{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:30px;
    margin-top:30px;
}

.card{
    background:white;
    padding:24px;
    border-radius:18px;
    box-shadow:0 14px 40px rgba(0,0,0,.08);
}

input, textarea{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid #d1d5db;
    margin-top:8px;
}

/* READONLY LOOK */
.readonly{
    background:#f9fafb;
    cursor:pointer;
}

button{
    background:#4f46e5;
    color:white;
    border:none;
    padding:12px 18px;
    border-radius:12px;
    cursor:pointer;
}
    .skills{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
}

.skill-tag{
    padding:8px 14px;
    border-radius:20px;
    background:#e5e7eb;
    cursor:pointer;
    transition:0.3s ease;
    font-size:14px;
}

.skill-tag.active{
    background:#4f46e5;
    color:white;
}

</style>

<form method="POST" enctype="multipart/form-data" id="profileForm">
{% csrf_token %}

<div class="profile-wrapper">

    <!-- ================= COVER ================= -->
    {% if profile.cover_photo %}
        <div class="cover"
             style="background-image:url('{{ profile.cover_photo.url }}');">
    {% else %}
        <div class="cover"
             style="background-image:url('{% static "images/cover.jpg" %}');">
    {% endif %}
            <label for="coverInput">‚úèÔ∏è Change Cover</label>
            <input id="coverInput" type="file" name="cover_photo" hidden>
        </div>

    <!-- ================= PROFILE PIC ================= -->
    <div class="avatar">
        {% if profile.photo %}
            <img src="{{ profile.photo.url }}">
        {% else %}
            <img src="{% static 'images/avatar.png' %}">
        {% endif %}

        <label for="photoInput">üì∑</label>
        <input id="photoInput" type="file" name="photo" hidden>
    </div>

    <!-- ================= INFO ================= -->
    <div class="info-grid">

        <!-- LEFT -->
        <div class="card">
    <h2>Basic Info</h2>

    <label>Full Name</label>
    <input name="full_name"
           value="{{ profile.full_name }}"
           disabled
           class="editable">

    <label>Phone</label>
    <input name="phone"
           value="{{ profile.phone }}"
           disabled
           class="editable">

    <label>Year</label><br>
    <select name="year" disabled class="editable">
        <option value="1st Year" {% if profile.year == "1st Year" %}selected{% endif %}>1st Year</option>
        <option value="2nd Year" {% if profile.year == "2nd Year" %}selected{% endif %}>2nd Year</option>
        <option value="3rd Year" {% if profile.year == "3rd Year" %}selected{% endif %}>3rd Year</option>
        <option value="4th Year" {% if profile.year == "4th Year" %}selected{% endif %}>4th Year</option>
    </select><br><br>

    <label>Skills</label>

<!-- NORMAL TEXT MODE -->
<p id="skillsText">{{ profile.skills }}</p>

<!-- EDIT MODE -->
<input type="hidden" name="skills" id="skillsInput">

<div class="skills" id="skillsBox" style="display:none;">
    <span class="skill-tag" onclick="toggleSkill(this)">Teaching</span>
    <span class="skill-tag" onclick="toggleSkill(this)">Event Management</span>
    <span class="skill-tag" onclick="toggleSkill(this)">Technical</span>
    <span class="skill-tag" onclick="toggleSkill(this)">Healthcare</span>
    <span class="skill-tag" onclick="toggleSkill(this)">Environment</span>
    <span class="skill-tag" onclick="toggleSkill(this)">Social Work</span>
</div>


    <br><br>

    <br><br>

<div class="btn-group">
    <button type="button" id="editBtn">Edit Profile</button>
    <button type="submit" id="saveBtn" style="display:none;">Save Changes</button>
    <button type="button" id="cancelBtn" style="display:none;">Cancel</button>
</div>

<div id="toast" class="toast">Profile Updated Successfully ‚úÖ</div>

</div>


        <!-- RIGHT -->
        <div class="card">
            <h3>Academic</h3>
            <p><b>ID:</b> {{ profile.student_id }}</p>
            <p><b>Dept:</b> {{ profile.department }}</p>
        </div>

    </div>

</div>

</form>

<!-- ================= SCRIPT ================= -->
<script>

// =========================
// ELEMENTS
// =========================
const editBtn = document.getElementById("editBtn");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const fields = document.querySelectorAll(".editable");
const toast = document.getElementById("toast");

const skillsText = document.getElementById("skillsText");
const skillsBox = document.getElementById("skillsBox");
const skillsInput = document.getElementById("skillsInput");

let originalValues = {};
let selectedSkills = [];

// =========================
// INITIAL SKILL SETUP
// =========================
if (skillsText && skillsText.innerText.trim() !== "") {
    selectedSkills = skillsText.innerText.split(",");
}

// Mark active skills initially
document.querySelectorAll(".skill-tag").forEach(tag => {
    if (selectedSkills.includes(tag.innerText.trim())) {
        tag.classList.add("active");
    }
});

// =========================
// IMAGE AUTO SUBMIT
// =========================
const photoInput = document.getElementById("photoInput");
const coverInput = document.getElementById("coverInput");

if (photoInput) {
    photoInput.addEventListener("change", () => {
        document.getElementById("profileForm").submit();
    });
}

if (coverInput) {
    coverInput.addEventListener("change", () => {
        document.getElementById("profileForm").submit();
    });
}

// =========================
// EDIT MODE
// =========================
editBtn.addEventListener("click", () => {

    // Save original values
    fields.forEach(field => {
        originalValues[field.name] = field.value;
        field.removeAttribute("disabled");
        field.classList.add("enabled");
    });

    // Show skill buttons
    if (skillsText && skillsBox) {
        skillsText.style.display = "none";
        skillsBox.style.display = "flex";
    }

    editBtn.style.display = "none";
    saveBtn.style.display = "inline-block";
    cancelBtn.style.display = "inline-block";
});

// =========================
// CANCEL EDIT
// =========================
cancelBtn.addEventListener("click", () => {

    // Restore original values
    fields.forEach(field => {
        field.value = originalValues[field.name];
        field.setAttribute("disabled", true);
        field.classList.remove("enabled");
    });

    // Restore skill UI
    if (skillsText && skillsBox) {
        skillsText.style.display = "block";
        skillsBox.style.display = "none";
    }

    // Reset active skill selection
    document.querySelectorAll(".skill-tag").forEach(tag => {
        tag.classList.remove("active");
        if (selectedSkills.includes(tag.innerText.trim())) {
            tag.classList.add("active");
        }
    });

    editBtn.style.display = "inline-block";
    saveBtn.style.display = "none";
    cancelBtn.style.display = "none";
});

// =========================
// SKILL TOGGLE
// =========================
function toggleSkill(el) {
    el.classList.toggle("active");
}

// =========================
// BEFORE SAVE (FORM SUBMIT)
// =========================
document.getElementById("profileForm").addEventListener("submit", function () {

    // Collect selected skills
    const activeSkills = [];
    document.querySelectorAll(".skill-tag.active").forEach(tag => {
        activeSkills.push(tag.innerText.trim());
    });

    // Set hidden input value
    if (skillsInput) {
        skillsInput.value = activeSkills.join(",");
    }

});

// =========================
// TOAST MESSAGE AFTER SAVE
// =========================
window.onload = function () {
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get("updated") === "true") {

        if (toast) {
            toast.classList.add("show");

            setTimeout(() => {
                toast.classList.remove("show");
            }, 3000);
        }

        // Remove query param from URL (clean URL)
        window.history.replaceState({}, document.title, window.location.pathname);
    }
};

</script>


{% endblock %}
